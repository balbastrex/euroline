import React, { useEffect, useContext } from "react";
import MenuList from "components/menu/MenuList";
import { CategoriesContext } from "/context/categories/categoriesContext";
import { CartContext } from "context/cart/cartContext";
import { UserContext } from "context/user/userContext";
import Link from "next/link";
import { getTokenSession } from "components/auth/authHelpers";
import Cart from "components/cart/Cart";
import { getPublicCart, getCustomerCart } from "api/apiRoutes";

const Header = ({ hideMenu, setHideMenu }) => {
  const categoriesContext = useContext(CategoriesContext);
  const { categories, categoriesSorted, getCategoriesSorted } =
    categoriesContext;
  const { tokenstored, setTokenStored } = useContext(UserContext);
  const cartContext = useContext(CartContext);
  const { cart, setCart, tokenCart } = cartContext;
  useEffect(() => {
    if (categoriesSorted.length === 0 && categories[0]) {
      getCategoriesSorted();
    }
  }, [categories, categoriesSorted.length, getCategoriesSorted]);

  useEffect(() => {
    const checkTokenSession = async () => {
      getTokenSession();
      if (!getTokenSession()) {
        setTokenStored(false);
        console.log("Not authorized");
        return;
      }
      setTokenStored(true);
    };

    checkTokenSession();
  }, [tokenstored]);

  //Cargamos carro.
  useEffect(() => {
    const getCart = async () => {
      /* Si hay tokenCart, cargamos carro público */
      if (tokenCart) {
        const publicCart = await getPublicCart(tokenCart);
        if (publicCart) {
          setCart(publicCart.cart);
        }
        return;
      }
      /* Si no, cargamos carro privado */
      if (tokenstored) {
        const customerCart = await getCustomerCart();
        if (customerCart) {
          setCart(customerCart.cart);
        }
        return;
      }
    };
    getCart();
  }, [setCart, tokenCart, tokenstored]);

  return (
    <header>
      <div id="top-header">
        <div className="container"></div>
      </div>
      <div id="header">
        <div className="container">
          <div className="burger icon" onClick={() => setHideMenu(!hideMenu)}>
            menu
          </div>
          {hideMenu ? (
            <>
              <MenuList hideMenu={hideMenu} setHideMenu={setHideMenu} />
            </>
          ) : null}
          <div className="logo">
            <Link href="/" passHref>
              <a>
                <svg
                  version="1.1"
                  id="Capa_1"
                  x="0px"
                  y="0px"
                  width="855px"
                  height="250px"
                  viewBox="0 0 855 250"
                >
                  <g>
                    <path
                      d="M201.672,182.047c-1.855,0.529-3.71,0.794-5.563,0.794c-5.563,0-10.6-1.855-14.838-5.562
		c-4.239-3.709-7.151-8.744-8.477-15.102l-13.777-59.872c-2.385-10.067-7.153-15.1-14.834-15.1c-4.505,0-7.947,1.324-10.597,4.238
		c-2.649,2.915-3.973,6.624-3.973,10.862c0,1.854,0.265,3.973,0.794,6.358l13.775,59.871c0.53,2.387,1.06,4.771,1.06,7.154
		c0,5.828-1.59,10.596-4.768,14.834c-3.18,4.241-7.683,7.154-13.511,8.479c-1.854,0.529-3.708,0.794-5.562,0.794
		c-5.563,0-10.6-1.853-14.838-5.562c-4.238-3.712-7.153-8.743-8.477-14.837l-13.778-60.136c-2.385-9.805-7.154-14.837-14.834-14.837
		c-9.802,0-14.834,4.768-14.834,14.304c0,2.123,0.264,4.506,1.058,7.155l13.776,60.136c0.529,2.384,1.058,4.503,1.058,6.887
		c0,5.831-1.589,10.863-5.032,15.102c-3.18,4.239-7.683,7.154-13.245,8.478c-1.854,0.264-3.973,0.531-5.828,0.531
		c-5.563,0-10.6-1.854-14.838-5.564c-4.239-3.708-7.153-8.74-8.477-14.834L1.917,104.69c-0.529-2.384-0.793-4.503-0.793-6.888
		c0-5.827,1.59-10.86,4.768-15.099c3.18-4.241,7.683-7.155,13.245-8.215c2.123-0.53,4.242-0.795,6.096-0.795
		c5.562,0,10.332,1.855,14.04,5.034c10.069-12.186,23.049-18.543,39.474-18.543c9.537,0,18.546,2.649,27.022,7.948
		c8.741-12.186,19.872-19.868,32.852-23.047c5.296-1.06,10.332-1.593,15.364-1.593c12.186,0,22.784,3.712,31.79,10.865
		c8.747,7.152,14.838,17.483,18.017,31.261l15.099,65.962c0.795,2.385,1.061,4.503,1.061,6.893c0,5.825-1.59,10.859-4.769,15.099
		C211.738,178.073,207.235,180.722,201.672,182.047"
                    />
                    <path
                      d="M237.698,54.356c-7.151,0.529-13.245-1.855-18.543-6.888c-5.297-5.034-8.211-11.129-8.742-18.28
		c-0.265-6.624,2.119-12.715,6.888-18.279c5.033-5.298,10.86-8.215,17.748-8.479c6.89-0.53,12.983,1.593,18.546,6.626
		c5.563,4.768,8.479,10.596,8.744,17.483c0.265,7.152-1.857,13.51-6.625,19.076C250.946,51.177,244.854,54.091,237.698,54.356
		 M245.383,200.857c-7.156,0.529-12.983-1.59-17.486-6.357c-4.769-4.77-7.153-10.599-7.417-18.018l-5.033-94.31
		c-0.531-7.42,1.324-13.513,5.563-18.545c4.238-5.033,9.802-7.947,16.689-8.478c7.157-0.264,12.983,1.855,17.487,6.624
		c4.769,4.768,7.155,10.596,7.42,18.013l5.299,94.313c0.265,7.418-1.59,13.512-5.829,18.546
		C257.834,197.944,252.27,200.593,245.383,200.857"
                    />
                    <path
                      d="M413.61,202.977c-9.009-0.794-17.487-3.974-25.437-9.006l-2.648,31.523
		c-0.531,7.418-3.444,13.247-8.212,17.75c-4.769,4.503-10.86,6.357-17.749,5.828c-6.888-0.528-12.184-3.444-16.423-8.741
		c-3.974-5.3-5.829-11.657-5.035-19.075l12.715-145.708c0.531-7.417,3.445-13.246,8.212-17.749
		c4.769-4.503,10.86-6.622,17.749-6.093c8.478,0.795,14.569,4.504,18.546,11.391c9.007-6.622,19.87-9.272,32.585-8.212
		c18.543,1.59,32.849,10.066,43.183,25.168c9.005,13.245,13.509,29.14,13.509,47.685c0,20.663-6.357,38.677-19.075,53.779
		C451.489,197.413,434.271,204.567,413.61,202.977 M418.378,98.861c-6.623-0.529-12.188,1.59-16.427,6.623
		c-4.238,5.033-6.888,11.924-7.418,20.136c-0.793,8.477,0.531,15.894,3.709,21.987c3.443,6.357,8.212,9.539,14.837,10.333
		c6.357,0.532,11.921-1.852,16.16-7.419c4.503-5.298,7.151-12.186,7.946-20.134c0.531-8.211-0.795-15.366-4.238-21.723
		C429.503,102.57,424.471,99.392,418.378,98.861"
                    />
                    <path
                      d="M509.773,54.356c-7.15,0.529-13.243-1.855-18.542-6.888c-5.301-5.034-8.48-11.129-8.745-18.28
		c-0.265-6.624,2.119-12.715,6.893-18.279c5.031-5.298,10.859-8.215,17.746-8.479c6.887-0.53,12.98,1.593,18.544,6.626
		c5.563,4.768,8.477,10.596,8.741,17.483c0.266,7.152-1.854,13.51-6.622,19.076C522.757,51.177,516.928,54.091,509.773,54.356
		 M517.192,200.857c-7.151,0.529-12.98-1.59-17.483-6.357c-4.77-4.77-7.153-10.599-7.418-18.018l-5.032-94.31
		c-0.529-7.42,1.323-13.513,5.562-18.545c4.238-5.033,9.803-7.947,16.688-8.478c7.152-0.264,12.979,1.855,17.486,6.624
		c4.767,4.768,7.15,10.596,7.415,18.013l5.032,94.313c0.268,7.418-1.591,13.512-5.828,18.546
		C529.907,197.944,524.344,200.593,517.192,200.857"
                    />
                    <path
                      d="M615.741,202.977c-9.006-0.794-17.482-3.974-25.431-9.006l-2.65,31.523
		c-0.529,7.418-3.442,13.247-8.21,17.75c-4.771,4.503-10.86,6.357-17.752,5.828c-6.887-0.528-12.45-3.444-16.425-8.741
		c-3.977-5.3-5.563-11.657-5.035-19.075l12.718-145.708c0.53-7.417,3.443-13.246,8.213-17.749
		c4.771-4.503,10.863-6.622,17.749-6.093c8.478,0.795,14.57,4.504,18.544,11.391c9.009-6.622,19.872-9.272,32.587-8.212
		c18.547,1.59,32.849,10.066,43.184,25.168c9.006,13.245,13.509,29.14,13.509,47.685c0,20.663-6.357,38.677-19.072,53.779
		C653.627,197.413,636.406,204.567,615.741,202.977 M620.512,98.861c-6.625-0.529-12.188,1.59-16.692,6.623
		c-4.238,5.033-6.887,11.924-7.416,20.136c-0.795,8.477,0.529,15.894,3.708,21.987c3.444,6.357,8.212,9.539,14.836,10.333
		c6.36,0.532,11.657-1.852,16.16-7.419c4.508-5.298,7.156-12.186,7.95-20.134c0.796-8.211-0.794-15.366-4.241-21.723
		C631.372,102.57,626.604,99.392,620.512,98.861"
                    />
                    <path
                      d="M759.063,202.713c-20.396,1.058-37.616-5.564-51.656-19.607c-13.511-13.51-20.665-30.466-21.99-50.863
		c-1.059-19.871,4.502-37.619,16.69-52.718c12.454-15.896,28.878-24.375,48.743-25.433c20.138-1.061,37.358,5.828,51.398,20.397
		c13.512,13.777,20.928,30.731,21.988,50.603c1.059,20.396-4.503,38.147-16.159,52.718
		C796.155,193.175,779.731,201.387,759.063,202.713 M753.766,98.597c-6.622,0.264-11.921,3.443-15.63,9.537
		c-3.707,6.092-5.297,13.248-4.768,21.725c0.528,8.212,2.916,15.099,7.154,20.397c4.238,5.564,9.535,7.951,16.157,7.684
		c6.621-0.265,11.923-3.442,15.633-9.272c3.709-5.829,5.296-12.98,4.768-21.457c-0.529-8.212-2.913-15.367-6.887-20.931
		C765.952,100.98,760.389,98.333,753.766,98.597"
                    />
                    <g>
                      <path
                        d="M814.963,53.296c0-3.443,0.797-6.624,2.649-9.801c1.854-2.918,3.973-5.302,7.153-7.156
			c2.913-1.854,6.357-2.648,9.8-2.648c3.444,0,6.627,0.795,9.805,2.648c2.916,1.854,5.3,3.974,7.154,7.156
			c1.852,2.913,2.647,6.358,2.647,9.801s-0.796,6.622-2.384,9.536c-1.59,2.914-3.974,5.298-7.153,7.153
			c-2.913,1.854-6.36,2.648-9.802,2.648c-3.445,0-6.888-0.794-9.803-2.648c-2.916-1.854-5.297-4.239-7.154-7.153
			C816.024,59.918,814.963,56.74,814.963,53.296z M818.144,53.296c0,2.914,0.794,5.563,2.119,8.212
			c1.588,2.384,3.441,4.503,6.093,5.827c2.384,1.324,5.297,2.119,8.21,2.119c2.915,0,5.564-0.795,8.212-2.119
			c2.653-1.589,4.509-3.443,5.831-6.093c1.325-2.384,2.119-5.298,2.119-8.212c0-2.913-0.794-5.563-2.119-8.211
			c-1.588-2.649-3.442-4.507-6.096-6.096c-2.647-1.325-5.297-2.119-8.212-2.119c-2.913,0-5.562,0.793-8.212,2.119
			c-2.385,1.325-4.504,3.446-6.091,5.83C818.938,47.733,818.144,50.382,818.144,53.296z M842.513,48.792
			c0,2.914-1.323,5.033-3.974,6.093l6.096,10.331h-5.563l-5.035-9.006h-2.384v9.006h-4.768V41.902h6.887
			c2.916,0,5.3,0.532,6.623,1.857C841.719,44.554,842.513,46.408,842.513,48.792z M831.917,52.237h1.854
			c1.325,0,2.119-0.265,2.916-0.795c0.528-0.53,1.059-1.588,1.059-2.649c0-1.324-0.266-2.119-1.059-2.648
			c-0.532-0.529-1.591-0.795-2.916-0.795h-1.854V52.237z"
                      />
                    </g>
                  </g>
                </svg>
              </a>
            </Link>
          </div>
          <div className="botones">
            <Link href="#">
              <a className="buscador">
                <div className="icon">search</div>
                <p>Buscar</p>
              </a>
            </Link>
            {tokenstored ? (
              <Link href="/profile">
                <a className="sesion">
                  <div className="icon">person</div>
                  <p>Mi Cuenta</p>
                </a>
              </Link>
            ) : (
              <Link href="/auth/register">
                <a className="sesion">
                  <div className="icon">person</div>
                  <p>Iniciar sesión</p>
                </a>
              </Link>
            )}
            <Link href="/cart">
              <a className="carrito">
                <div className="icon">
                  shopping_cart
                  {cart && cart.lines && cart.lines.length >= 1 ? (
                    <p className="contador">{cart.lines.length}</p>
                  ) : (
                    <p className="contador">0</p>
                  )}
                </div>
                <p>Carrito</p>
              </a>
            </Link>
          </div>
        </div>
      </div>
      <div id="aviso-header">
        <div className="container">
          <p className="teleprompter">
            Chanante ipsum dolor sit amet, tontiploster, freshquisimo ad
            atiendee zagal hueles avinagrado ju-já chotera et. Veniam tempor sed
            estoy fatal de lo mío agazapao. Horcate incididunt, veniam cosica
            exercitation droja bizcoché elit coconut ad dolore, traeros tol
            jamón interneeeer gañán.
          </p>
        </div>
      </div>
    </header>
  );
};

export default Header;
